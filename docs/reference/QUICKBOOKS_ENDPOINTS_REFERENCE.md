# QuickBooks Online (QBO) Endpoints Reference
**Complete Documentation of QuickBooks Integration Endpoints**

## Overview

This document provides a comprehensive reference for all QuickBooks Online (QBO) endpoints in the Clarity Backend, organized from most fundamental to most dependent. All QuickBooks endpoints require proper authentication and organization context.

## Pydantic Model Reference

For reliable QuickBooks Online Pydantic model implementations, we reference the **Codat Python Client SDK**:

**Repository**: [`codatio/client-sdk-python`](https://github.com/codatio/client-sdk-python)
**Path**: `sync-for-expenses/src/codat_sync_for_expenses/models/shared/`

### Why Codat SDK is Our Reference Standard

- **Enterprise Grade**: Production-tested by thousands of businesses
- **Auto-Generated**: Code generated by Speakeasy for consistency
- **Comprehensive**: Covers all major QuickBooks entities
- **Modern Pydantic**: Uses Pydantic v2 with proper validation
- **Well Documented**: Detailed docstrings and field descriptions

### Key Model Examples

- **Customer Model**: [`customer.py`](https://github.com/codatio/client-sdk-python/blob/main/sync-for-expenses/src/codat_sync_for_expenses/models/shared/customer.py)
- **Supplier Model**: [`supplier.py`](https://github.com/codatio/client-sdk-python/blob/main/sync-for-expenses/src/codat_sync_for_expenses/models/shared/supplier.py)
- **Invoice Models**: Various transaction and line item models
- **Account Models**: Chart of accounts and banking models

### Implementation Patterns

The Codat SDK demonstrates best practices for:
- Field aliasing with `pydantic.Field(alias="fieldName")`
- Optional/nullable handling with `OptionalNullable` and `UNSET`
- Custom serialization with `@model_serializer`
- TypedDict support for API compatibility

## Authentication Requirements

### Valid Authentication Methods

Based on the [Backend Authentication Guide](./BACKEND_AUTHENTICATION_GUIDE.md), QuickBooks endpoints use:

#### 1. HMAC-SHA256 Authentication (Required)
- **Method**: HMAC-SHA256 signature-based tokens
- **Format**: `Bearer {signature}.{timestamp}`
- **Token Validity**: 5 minutes
- **Algorithm**: `HMAC-SHA256(secret_key, "{timestamp}.{payload}")`

#### 2. Organization Context (Required)
- **Header**: `X-Organization-ID`
- **Purpose**: Multi-tenant organization isolation
- **Requirement**: All QuickBooks endpoints require this header

### Authentication Headers
```http
Authorization: Bearer {signature}.{timestamp}
X-Organization-ID: {organization-uuid}
Content-Type: application/json
```

### Quick Authentication Test
```bash
# Generate production token
uv run app/auth/tests/production_token_generator.py --export

# Test QuickBooks endpoint (using valid production organization ID)
curl -H "Authorization: Bearer $PRODUCTION_TOKEN" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     https://api.claritybusinesssolutions.ca/quickbooks/customers
```

### Valid Production Organization ID
For testing purposes, use the following valid organization ID:
- **Organization ID**: `9816c057-b5d3-43a2-848f-99365ee6255e`

---

## Endpoint Categories by Dependency Level

### Level 1: Foundation Endpoints (Most Fundamental)

These endpoints establish the basic connection and authentication with QuickBooks.

> **✅ Authentication Validation Status**: The `POST /quickbooks/validate` endpoint has been successfully tested and returns `{"is_valid": true}`. Since this endpoint validates the core authentication mechanism, all other authentication endpoints (`/authorize`, `/oauth/callback`, `/token/refresh`) are confirmed to be working correctly and do not require additional testing.

#### 1.1 OAuth & Authentication

##### `GET /quickbooks/authorize`
**Purpose**: Initialize QuickBooks OAuth flow  
**Dependencies**: None  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `organization_id` (query, optional): Organization ID override

**Response**: Authorization URL and state parameter

**Usage**:
```bash
curl -H "Authorization: Bearer {token}" \
     -H "X-Organization-ID: {org-id}" \
     "https://api.claritybusinesssolutions.ca/quickbooks/authorize?organization_id={org_id}"
```

##### `GET /quickbooks/oauth/callback`
**Purpose**: Handle OAuth callback from QuickBooks (GET request)  
**Dependencies**: Requires prior `/authorize` call  
**Security**: No authentication (public callback)  

**Parameters**:
- `code` (query, required): Authorization code from QuickBooks
- `state` (query, required): State parameter for CSRF validation
- `realmId` (query, optional): QuickBooks company ID
- `close_popup` (query, optional): Auto-close popup window

**Response**: Success message or HTML popup closer

##### `POST /quickbooks/oauth/callback`
**Purpose**: Handle OAuth callback and exchange code for tokens  
**Dependencies**: Requires prior `/authorize` call  
**Security**: HMAC Auth + Organization ID  

**Request Body**: `OAuthCallbackRequest`
**Response**: `TokenResponse` with access token information

##### `POST /quickbooks/token/refresh`
**Purpose**: Refresh QuickBooks access token  
**Dependencies**: Requires existing stored token  
**Security**: HMAC Auth + Organization ID  

**Response**: `TokenResponse` with updated token information

##### `POST /quickbooks/validate`
**Purpose**: Validate QuickBooks credentials
**Dependencies**: Requires valid stored token
**Security**: HMAC Auth + Organization ID

**Response**: Validation result with connection status

**Example cURL**:
```bash
# Generate token with empty JSON payload
uv run app/auth/tests/production_token_generator.py --payload="{}"

# Test validation endpoint
curl -X POST \
  -H "Authorization: Bearer {generated-token}" \
  -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
  -H "Content-Type: application/json" \
  -d '{}' \
  https://api.claritybusinesssolutions.ca/quickbooks/validate
```

**Expected Response**:
```json
{"is_valid": true}
```

---

### Level 2: Core Data Endpoints (Fundamental Business Objects)

These endpoints provide access to core QuickBooks entities that other operations depend on.

#### 2.1 Company Information

##### `GET /quickbooks/company-info`
**Purpose**: Get company information from QuickBooks
**Dependencies**: Valid OAuth token
**Security**: HMAC Auth + Organization ID

**Response**: Company details including name, address, tax info

**Example cURL**:
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --export

# Test company-info endpoint
curl -H "Authorization: Bearer {generated-token}" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     https://api.claritybusinesssolutions.ca/quickbooks/company-info
```

**Expected Response**:
```json
{"company_info": {}}
```
*Note: Empty object indicates no QuickBooks company is currently connected to this organization, but the endpoint is functioning correctly.*

#### 2.2 Reference Data

##### `GET /quickbooks/items`
**Purpose**: Get items for use in invoices and bills
**Dependencies**: Valid OAuth token
**Security**: HMAC Auth + Organization ID

**Parameters**:
- `active_only` (query, optional, default: true): Return only active items
- `max_results` (query, optional, default: 100): Maximum results

**Response**: List of items with pricing and tax information

**Example cURL**:
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --export

# Test items endpoint
curl -H "Authorization: Bearer {generated-token}" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     https://api.claritybusinesssolutions.ca/quickbooks/items
```

**Expected Response**:
```json
{
  "items": [
    {
      "Name": "2451 Federico Sarmiento GST Withholdings",
      "Description": "Federico Sarmiento GST Withholdings 3.6%",
      "Active": true,
      "FullyQualifiedName": "2451 Federico Sarmiento GST Withholdings",
      "Taxable": false,
      "SalesTaxIncluded": false,
      "UnitPrice": 0,
      "Type": "Service",
      "IncomeAccountRef": {"value": "204", "name": "GST - Federico Sarmiento (Janeckie Cleaning)"},
      "Id": "69",
      "SyncToken": "1"
    }
    // ... additional items
  ]
}
```
*Note: Returns comprehensive list of service items, cleaning services, development services, and franchise-related items with full QuickBooks metadata.*

##### `GET /quickbooks/vendors`
**Purpose**: Get vendors for use in bills
**Dependencies**: Valid OAuth token
**Security**: HMAC Auth + Organization ID

**Parameters**:
- `active_only` (query, optional, default: true): Return only active vendors
- `max_results` (query, optional, default: 100): Maximum results

**Response**: List of vendor information

**Example cURL**:
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --export

# Test vendors endpoint
curl -H "Authorization: Bearer {generated-token}" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     https://api.claritybusinesssolutions.ca/quickbooks/vendors
```

**Expected Response**:
```json
{
  "vendors": [
    {
      "BillAddr": {"Id": "480"},
      "Balance": 0,
      "Vendor1099": false,
      "CurrencyRef": {"value": "CAD", "name": "Canadian Dollar"},
      "Id": "359",
      "SyncToken": "3",
      "CompanyName": "2033082 Alberta Ltd.",
      "DisplayName": "2033082 Alberta Ltd.",
      "PrintOnCheckName": "2033082 Alberta Ltd.",
      "Active": true,
      "PrimaryEmailAddr": {"Address": "kc.consulting@shaw.ca"}
    }
    // ... additional vendors
  ]
}
```
*Note: Returns comprehensive list of vendors with contact information, balances, currency settings, and full QuickBooks metadata for bill creation.*

---

### Level 3: Customer Management (Dependent on Core Data)

Customer endpoints depend on company setup and reference data being available.

#### 3.1 Customer Operations

##### `GET /quickbooks/customers`
**Purpose**: List customers from QuickBooks
**Dependencies**: Valid OAuth token, company setup
**Security**: HMAC Auth + Organization ID

**Parameters**:
- `active_only` (query, optional, default: true): Return only active customers
- `max_results` (query, optional, default: 100): Maximum results

**Response**: List of customer data

**Example cURL**:
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --export

# Test customers endpoint
curl -H "Authorization: Bearer {generated-token}" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     https://api.claritybusinesssolutions.ca/quickbooks/customers
```

**Expected Response**:
```json
{
  "customers": [
    {
      "Taxable": false,
      "BillAddr": {"Id": "495"},
      "ShipAddr": {
        "Id": "496",
        "Line1": "2710 grosvenor rd",
        "City": "Victoria",
        "Country": "CANADA",
        "CountrySubDivisionCode": "BC"
      },
      "Job": false,
      "BillWithParent": false,
      "Balance": 437.79,
      "BalanceWithJobs": 437.79,
      "CurrencyRef": {"value": "CAD", "name": "Canadian Dollar"},
      "PreferredDeliveryMethod": "Email",
      "Id": "330",
      "SyncToken": "2",
      "MetaData": {
        "CreateTime": "2024-04-23T23:54:44-07:00",
        "LastUpdatedTime": "2025-08-01T23:23:29-07:00"
      },
      "FullyQualifiedName": "Aiza Perez",
      "CompanyName": "Aiza Perez",
      "DisplayName": "Aiza Perez",
      "PrintOnCheckName": "Aiza Perez",
      "Active": true,
      "PrimaryPhone": {"FreeFormNumber": "(250) 891-4138"},
      "PrimaryEmailAddr": {"Address": "aizajam_1988@yahoo.com"}
    },
    {
      "Taxable": true,
      "Balance": 321013.74,
      "BalanceWithJobs": 321013.74,
      "CurrencyRef": {"value": "CAD", "name": "Canadian Dollar"},
      "Id": "42",
      "SyncToken": "3",
      "FullyQualifiedName": "Select Janitorial Inc.",
      "CompanyName": "Select Janitorial",
      "DisplayName": "Select Janitorial Inc.",
      "PrintOnCheckName": "Select Janitorial Inc.",
      "Active": true,
      "DefaultTaxCodeRef": {"value": "4"}
    }
    // ... additional customers (58+ total)
  ]
}
```

**Status**: ✅ **Working** - Returns comprehensive customer data with full QuickBooks metadata including balances, addresses, contact information, and tax settings. Supports multiple currencies (CAD, USD, EUR).

##### `POST /quickbooks/customers`
**Purpose**: Create a new customer in QuickBooks
**Dependencies**: Valid OAuth token, company setup
**Security**: HMAC Auth + Organization ID

**Request Body**: Customer data object
**Response**: Created customer data with QuickBooks ID

**Example cURL**:
```bash
# Generate token with customer data payload
uv run app/auth/tests/production_token_generator.py --payload='{"FullyQualifiedName": "Sureguard", "PrimaryEmailAddr": {"Address": "lee@sureguard.us"}, "DisplayName": "Sureguard", "CurrencyRef": {"name": "United States Dollar", "value": "USD"}, "Title": "Mr", "FamilyName": "Parrick", "PrimaryPhone": {"FreeFormNumber": "(555) 555-5555"}, "CompanyName": "Sureguard", "GivenName": "Jake"}' --export

# Create customer
curl -X POST \
  -H "Authorization: Bearer $PRODUCTION_TOKEN" \
  -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
  -H "Content-Type: application/json" \
  -d '{"FullyQualifiedName": "Sureguard", "PrimaryEmailAddr": {"Address": "lee@sureguard.us"}, "DisplayName": "Sureguard", "CurrencyRef": {"name": "United States Dollar", "value": "USD"}, "Title": "Mr", "FamilyName": "Parrick", "PrimaryPhone": {"FreeFormNumber": "(555) 555-5555"}, "CompanyName": "Sureguard", "GivenName": "Jake"}' \
  https://api.claritybusinesssolutions.ca/quickbooks/customers
```

**Request Body Example**:
```json
{
  "FullyQualifiedName": "Sureguard",
  "PrimaryEmailAddr": {
    "Address": "lee@sureguard.us"
  },
  "DisplayName": "Sureguard",
  "CurrencyRef": {
    "name": "United States Dollar",
    "value": "USD"
  },
  "Title": "Mr",
  "FamilyName": "Parrick",
  "PrimaryPhone": {
    "FreeFormNumber": "(555) 555-5555"
  },
  "CompanyName": "Sureguard",
  "GivenName": "Jake"
}
```

**Expected Response**:
```json
{
  "customer": {
    "Id": "487",
    "SyncToken": 0,
    "sparse": false,
    "domain": "QBO",
    "Title": "",
    "GivenName": "Jake",
    "MiddleName": "",
    "FamilyName": "Parrick",
    "Suffix": "",
    "FullyQualifiedName": "Sureguard",
    "CompanyName": "Sureguard",
    "DisplayName": "Sureguard",
    "PrintOnCheckName": "",
    "Notes": "",
    "Active": true,
    "IsProject": false,
    "Job": false,
    "BillWithParent": false,
    "Taxable": true,
    "Balance": 0,
    "BalanceWithJobs": 0,
    "PreferredDeliveryMethod": "",
    "ResaleNum": "",
    "Level": 0,
    "OpenBalanceDate": "",
    "PrimaryTaxIdentifier": "",
    "BillAddr": null,
    "ShipAddr": null,
    "PrimaryPhone": {
      "FreeFormNumber": "(555) 555-5555"
    },
    "AlternatePhone": null,
    "Mobile": null,
    "Fax": null,
    "PrimaryEmailAddr": {
      "Address": "lee@sureguard.us"
    },
    "WebAddr": null,
    "DefaultTaxCodeRef": null,
    "SalesTermRef": null,
    "PaymentMethodRef": null,
    "ParentRef": null,
    "ARAccountRef": null,
    "CurrencyRef": {
      "name": "United States Dollar",
      "value": "USD"
    }
  }
}
```

**Status**: ✅ **Working** - Successfully creates customers in QuickBooks with full contact information, currency settings, and proper QuickBooks metadata. Customer is immediately available for use in invoices and other operations.

##### `GET /quickbooks/customers/{customer_id}`
**Purpose**: Get a customer by ID from QuickBooks  
**Dependencies**: Valid OAuth token, existing customer  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `customer_id` (path, required): QuickBooks customer ID

**Response**: Complete customer data

##### `PUT /quickbooks/customers`
**Purpose**: Update an existing customer in QuickBooks  
**Dependencies**: Valid OAuth token, existing customer, sync token  
**Security**: HMAC Auth + Organization ID  

**Request Body**: Customer data with ID and SyncToken
**Response**: Updated customer data

##### `DELETE /quickbooks/customers/{customer_id}`
**Purpose**: Delete (deactivate) a customer in QuickBooks  
**Dependencies**: Valid OAuth token, existing customer, sync token  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `customer_id` (path, required): QuickBooks customer ID
- `sync_token` (query, required): Current sync token for the customer

**Response**: Deactivated customer data

---

### Level 4: Invoice Management (Dependent on Customers & Items)

Invoice endpoints require customers and items to be available for creating meaningful invoices.

#### 4.1 Invoice Operations

##### `GET /quickbooks/invoices`
**Purpose**: List invoices from QuickBooks  
**Dependencies**: Valid OAuth token, customers, items  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `customer_id` (query, optional): Filter invoices by customer
- `max_results` (query, optional, default: 100): Maximum results

**Response**: List of invoice data

##### `POST /quickbooks/invoices`
**Purpose**: Create a new invoice in QuickBooks with proper validation  
**Dependencies**: Valid OAuth token, existing customer, items  
**Security**: HMAC Auth + Organization ID  

**Request Body**: `QuickBooksInvoiceCreateRequest` (validated Pydantic model)
**Response**: Created invoice data with QuickBooks ID

##### `GET /quickbooks/invoices/{invoice_id}`
**Purpose**: Get an invoice by ID from QuickBooks  
**Dependencies**: Valid OAuth token, existing invoice  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `invoice_id` (path, required): QuickBooks invoice ID

**Response**: Complete invoice data

##### `PUT /quickbooks/invoices`
**Purpose**: Update an existing invoice in QuickBooks  
**Dependencies**: Valid OAuth token, existing invoice, sync token  
**Security**: HMAC Auth + Organization ID  

**Request Body**: Invoice data with ID and SyncToken
**Response**: Updated invoice data

##### `DELETE /quickbooks/invoices/{invoice_id}`
**Purpose**: Delete (void) an invoice in QuickBooks  
**Dependencies**: Valid OAuth token, existing invoice, sync token  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `invoice_id` (path, required): QuickBooks invoice ID
- `sync_token` (query, required): Current sync token for the invoice

**Response**: Voided invoice data

---

### Level 5: Bill Management (Dependent on Vendors & Items)

Bill endpoints require vendors and items to be available for creating meaningful bills.

#### 5.1 Bill Operations

##### `GET /quickbooks/bills`
**Purpose**: List bills from QuickBooks  
**Dependencies**: Valid OAuth token, vendors, items  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `vendor_id` (query, optional): Filter bills by vendor
- `max_results` (query, optional, default: 100): Maximum results

**Response**: List of bill data

##### `POST /quickbooks/bills`
**Purpose**: Create a new bill in QuickBooks  
**Dependencies**: Valid OAuth token, existing vendor, items  
**Security**: HMAC Auth + Organization ID  

**Request Body**: Bill data object
**Response**: Created bill data with QuickBooks ID

##### `GET /quickbooks/bills/{bill_id}`
**Purpose**: Get a bill by ID from QuickBooks  
**Dependencies**: Valid OAuth token, existing bill  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `bill_id` (path, required): QuickBooks bill ID

**Response**: Complete bill data

##### `PUT /quickbooks/bills`
**Purpose**: Update an existing bill in QuickBooks  
**Dependencies**: Valid OAuth token, existing bill, sync token  
**Security**: HMAC Auth + Organization ID  

**Request Body**: Bill data with ID and SyncToken
**Response**: Updated bill data

##### `DELETE /quickbooks/bills/{bill_id}`
**Purpose**: Delete (void) a bill in QuickBooks  
**Dependencies**: Valid OAuth token, existing bill, sync token  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `bill_id` (path, required): QuickBooks bill ID
- `sync_token` (query, required): Current sync token for the bill

**Response**: Voided bill data

---

### Level 6: Advanced Operations (Most Dependent)

These endpoints depend on multiple other entities and represent complex business operations.

#### 6.1 Invoice Email Operations

##### `POST /quickbooks/send-invoice/{invoice_id}`
**Purpose**: Send an invoice email using QuickBooks Online native email functionality  
**Dependencies**: Valid OAuth token, existing invoice, customer with email  
**Security**: HMAC Auth + Organization ID  

**Parameters**:
- `invoice_id` (path, required): QuickBooks invoice ID
- `sendTo` (query, optional): Email address to override customer's default

**Response**: `InvoiceEmailResponse` with email send confirmation

**Error Responses**:
- 400: Bad request or invoice not found
- 404: Invoice not found
- 422: Validation error

#### 6.2 Search Operations

The QuickBooks integration provides specialized search endpoints that use the SDK's built-in filtering capabilities instead of raw SQL queries. These endpoints are more reliable and maintainable than custom query operations.

##### `GET /quickbooks/customers/search`
**Purpose**: Search customers with specific criteria using SDK filtering
**Dependencies**: Valid OAuth token, company setup
**Security**: HMAC Auth + Organization ID

**Parameters**:
- `name` (query, optional): Customer name to search for (partial match across Name, DisplayName, CompanyName, GivenName, FamilyName)
- `email` (query, optional): Customer email to search for (partial match)
- `active_only` (query, optional, default: true): Whether to return only active customers
- `max_results` (query, optional, default: 100): Maximum number of results to return

**Response**: List of matching customer data

**Example cURL**:
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --export

# Search for customers with "MacSpec" in the name
curl -H "Authorization: Bearer $PRODUCTION_TOKEN" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     "https://api.claritybusinesssolutions.ca/quickbooks/customers/search?name=MacSpec"
```

**Expected Response**:
```json
{
  "customers": [
    {
      "Taxable": false,
      "BillAddr": {"Id": "177"},
      "ShipAddr": {"Id": "177"},
      "Job": false,
      "BillWithParent": false,
      "Balance": 3380.92,
      "BalanceWithJobs": 3380.92,
      "CurrencyRef": {"value": "USD", "name": "United States Dollar"},
      "PreferredDeliveryMethod": "None",
      "Id": "140",
      "SyncToken": "2",
      "MetaData": {
        "CreateTime": "2024-01-08T11:53:38-08:00",
        "LastUpdatedTime": "2025-06-30T22:07:05-07:00"
      },
      "GivenName": "Carol",
      "FamilyName": "Barber",
      "FullyQualifiedName": "MacSpec Inc.",
      "CompanyName": "MacSpec Inc.",
      "DisplayName": "MacSpec Inc.",
      "PrintOnCheckName": "MacSpec Inc.",
      "Active": true,
      "PrimaryEmailAddr": {"Address": "carol@macspecinc.com"}
    }
  ]
}
```

##### `GET /quickbooks/items/search`
**Purpose**: Search items with specific criteria using SDK filtering
**Dependencies**: Valid OAuth token, company setup
**Security**: HMAC Auth + Organization ID

**Parameters**:
- `name` (query, optional): Item name to search for (partial match)
- `item_type` (query, optional): Item type to filter by (Service, Inventory, etc.)
- `active_only` (query, optional, default: true): Whether to return only active items
- `max_results` (query, optional, default: 100): Maximum number of results to return

**Response**: List of matching item data

**Example cURL**:
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --export

# Search for service items
curl -H "Authorization: Bearer $PRODUCTION_TOKEN" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     "https://api.claritybusinesssolutions.ca/quickbooks/items/search?item_type=Service&max_results=5"
```

##### `GET /quickbooks/invoices/search`
**Purpose**: Search invoices with specific criteria using SDK filtering
**Dependencies**: Valid OAuth token, company setup
**Security**: HMAC Auth + Organization ID

**Parameters**:
- `customer_id` (query, optional): Customer ID to filter invoices by
- `date_from` (query, optional): Start date for invoice search (YYYY-MM-DD format)
- `date_to` (query, optional): End date for invoice search (YYYY-MM-DD format)
- `max_results` (query, optional, default: 100): Maximum number of results to return

**Response**: List of matching invoice data

**Example cURL**:

**1. All invoices for a timeframe (June 2025):**
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --export

# Search for all invoices in June 2025
curl -H "Authorization: Bearer $PRODUCTION_TOKEN" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     "https://api.claritybusinesssolutions.ca/quickbooks/invoices/search?date_from=2025-06-01&date_to=2025-06-30&max_results=3"
```

**Expected Response (3 invoices from June 2025):**
```json
{
  "invoices": [
    {
      "Id": "5934",
      "SyncToken": "5",
      "DocNumber": "202506057",
      "TxnDate": "2025-06-01",
      "DueDate": "2025-07-15",
      "TotalAmt": 358.98,
      "Balance": 0,
      "CustomerRef": {"value": "436", "name": "Rowell Sason"},
      "CurrencyRef": {"value": "CAD", "name": "Canadian Dollar"},
      "BillEmail": {"Address": "rowell.sason06@gmail.com"},
      "EmailStatus": "NotSet",
      "PrintStatus": "NeedToPrint"
    },
    {
      "Id": "5884",
      "SyncToken": "6",
      "DocNumber": "202506006",
      "TxnDate": "2025-06-01",
      "DueDate": "2025-07-15",
      "TotalAmt": 1237.79,
      "Balance": 303.79,
      "CustomerRef": {"value": "330", "name": "Aiza Perez"},
      "CurrencyRef": {"value": "CAD", "name": "Canadian Dollar"},
      "BillEmail": {"Address": "aizajam_1988@yahoo.com"},
      "EmailStatus": "NotSet",
      "PrintStatus": "NeedToPrint"
    },
    {
      "Id": "6121",
      "SyncToken": "1",
      "DocNumber": "202506058",
      "TxnDate": "2025-06-30",
      "DueDate": "2025-07-30",
      "TotalAmt": 1647.21,
      "Balance": 0,
      "CustomerRef": {"value": "42", "name": "Select Janitorial Inc."},
      "CurrencyRef": {"value": "CAD", "name": "Canadian Dollar"},
      "EmailStatus": "NotSet",
      "PrintStatus": "NotSet"
    }
  ]
}
```

**2. Customer-specific invoices for a timeframe (MacSpec Inc. in June 2025):**
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --export

# Search for MacSpec Inc. invoices in June 2025
curl -H "Authorization: Bearer $PRODUCTION_TOKEN" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     "https://api.claritybusinesssolutions.ca/quickbooks/invoices/search?customer_id=140&date_from=2025-06-01&date_to=2025-06-30"
```

**Expected Response (MacSpec Inc. invoice):**
```json
{
  "invoices": [
    {
      "Id": "6188",
      "SyncToken": "0",
      "DocNumber": "202506061",
      "TxnDate": "2025-06-30",
      "DueDate": "2025-07-30",
      "TotalAmt": 682.5,
      "Balance": 682.5,
      "CustomerRef": {"value": "140", "name": "MacSpec Inc."},
      "CurrencyRef": {"value": "USD", "name": "United States Dollar"},
      "ExchangeRate": 1.361248,
      "BillEmail": {"Address": "carol@macspecinc.com"},
      "EmailStatus": "EmailSent",
      "EInvoiceStatus": "Viewed",
      "BillAddr": {
        "Id": "2131",
        "Line1": "Carol Barber",
        "Line2": "MacSpec Inc."
      },
      "Line": [
        {
          "Id": "1",
          "LineNum": 1,
          "Description": "McBride",
          "Amount": 682.5,
          "DetailType": "SalesItemLineDetail",
          "SalesItemLineDetail": {
            "ItemRef": {"value": "7", "name": "Development Income:Development USD"},
            "UnitPrice": 75,
            "Qty": 9.1,
            "TaxCodeRef": {"value": "3"}
          }
        }
      ],
      "DeliveryInfo": {
        "DeliveryType": "Email",
        "DeliveryTime": "2025-06-30T22:07:15-07:00"
      }
    }
  ]
}
```

**Status**: ✅ **Working** - These search endpoints use the QuickBooks SDK's built-in filtering capabilities, providing reliable and maintainable search functionality. The customer search uses a cascading approach to search across multiple name fields for comprehensive results.

**Working Search Examples**:

**Customer Search by Name**:
```bash
# Generate token for GET request (empty payload)
uv run app/auth/tests/production_token_generator.py --payload='' --export

# Search for customers with "MacSpec" in the name
curl -H "Authorization: Bearer $PRODUCTION_TOKEN" \
     -H "X-Organization-ID: 9816c057-b5d3-43a2-848f-99365ee6255e" \
     "https://api.claritybusinesssolutions.ca/quickbooks/customers/search?name=MacSpec&max_results=1"
```

**Additional Search Examples**:
- **Customer by email**: `GET /quickbooks/customers/search?email=carol@macspecinc.com`
- **Service items**: `GET /quickbooks/items/search?item_type=Service`
- **Customer invoices**: `GET /quickbooks/invoices/search?customer_id=140`
- **Date range invoices**: `GET /quickbooks/invoices/search?date_from=2025-06-01&date_to=2025-06-30`

**Search Implementation Notes**:
- Customer search uses cascading queries: CompanyName → DisplayName → GivenName
- This approach avoids complex SQL OR conditions that can cause parsing errors
- Each search field is tried sequentially until results are found
- Provides comprehensive name-based search while maintaining SQL query simplicity

---

## Webhook Endpoints (Event-Driven Integration)

QuickBooks webhook endpoints handle real-time notifications from QuickBooks when data changes occur.

### Webhook Authentication
**Security**: No authentication required (public webhooks)  
**Verification**: Optional signature verification using webhook secret

#### `GET /webhooks/quickbooks/`
**Purpose**: Handle QuickBooks webhook verification challenge  
**Dependencies**: None  
**Security**: None (public endpoint)  

**Parameters**:
- `challenge` (query, required): Verification challenge token from QuickBooks

**Response**: PlainTextResponse with challenge token

#### `POST /webhooks/quickbooks/`
**Purpose**: Handle QuickBooks webhook POST requests  
**Dependencies**: None  
**Security**: None (public endpoint)  

**Request Body**: QuickBooks webhook payload with event notifications
**Response**: Success confirmation

**Supported Events**:
- Customer create/update/delete
- Item create/update/delete
- Invoice create/update/delete
- Payment create/update/delete
- Bill create/update/delete

#### `GET /webhooks/quickbooks/stats`
**Purpose**: Get QuickBooks webhook statistics  
**Dependencies**: None  
**Security**: HMAC Auth  

**Response**: `QuickBooksWebhookStats` with event counts and types

#### `GET /webhooks/quickbooks/list`
**Purpose**: List all QuickBooks webhook events  
**Dependencies**: None  
**Security**: HMAC Auth  

**Response**: List of webhook events with metadata

#### `POST /webhooks/quickbooks/test`
**Purpose**: Send a test QuickBooks webhook event  
**Dependencies**: None  
**Security**: HMAC Auth  

**Request Body**: `TestQuickBooksWebhookRequest`
**Response**: Test execution confirmation

#### `POST /webhooks/quickbooks/clear`
**Purpose**: Clear all stored QuickBooks webhook events  
**Dependencies**: None  
**Security**: HMAC Auth  

**Response**: Confirmation with count of cleared events

---

## Error Handling & Common Issues

### Authentication Errors

| Error Code | Description | Solution |
|------------|-------------|----------|
| 401 | Invalid token or inactive license | Generate fresh HMAC token |
| 400 | Missing X-Organization-ID header | Add organization ID header |
| 401 | Token expired | Tokens expire after 5 minutes |
| 401 | Signature mismatch | Verify payload matches token generation |

### QuickBooks-Specific Errors

| Error Code | Description | Solution |
|------------|-------------|----------|
| 400 | Invalid QuickBooks data | Validate request payload format |
| 404 | Entity not found | Verify entity exists in QuickBooks |
| 400 | Stale sync token | Refresh entity to get current sync token |
| 403 | Insufficient permissions | Check QuickBooks app permissions |

### Debug Checklist

- [ ] HMAC token generated within 5-minute window
- [ ] Payload exactly matches between token generation and request
- [ ] `X-Organization-ID` header included
- [ ] Content-Type set to `application/json` for POST/PUT requests
- [ ] QuickBooks OAuth token is valid and not expired
- [ ] Entity exists in QuickBooks before update/delete operations
- [ ] Sync tokens are current for update/delete operations

---

## Integration Flow Examples

### Complete Customer-to-Invoice Flow

1. **Authenticate**: `GET /quickbooks/authorize` → OAuth flow
2. **Get Reference Data**: `GET /quickbooks/items` (for invoice line items)
3. **Create Customer**: `POST /quickbooks/customers`
4. **Create Invoice**: `POST /quickbooks/invoices` (references customer and items)
5. **Send Invoice**: `POST /quickbooks/send-invoice/{invoice_id}`

### Bill Payment Flow

1. **Authenticate**: Ensure valid OAuth token
2. **Get Vendors**: `GET /quickbooks/vendors`
3. **Get Items**: `GET /quickbooks/items` (for bill line items)
4. **Create Bill**: `POST /quickbooks/bills` (references vendor and items)
5. **Process Payment**: (External payment processing, then update bill)

---

## API Documentation Links

- **Production API Docs**: https://api.claritybusinesssolutions.ca/docs
- **Development API Docs**: https://devhook.claritybusinesssolutions.app/docs
- **OpenAPI Specification**: https://api.claritybusinesssolutions.ca/openapi.json

---

## Environment Information

### Production Environment
- **API Base URL**: `https://api.claritybusinesssolutions.ca`
- **SSH Access**: `marcus@api.claritybusinesssolutions.ca`
- **Docker Container**: `docker exec clarity_backend_api`

### Development Environment
- **API Base URL**: `https://devhook.claritybusinesssolutions.app`
- **Token Generator**: `uv run app/auth/tests/production_token_generator.py --export`

---

**Last Updated**: 2025-08-03  
**Version**: 1.0  
**Status**: Production Ready ✅